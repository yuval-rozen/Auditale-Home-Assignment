<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Customer Health — Dashboard</title>
  <style>
    :root{
      --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --muted:#6b7280;
      --text:#0f172a; --bg:#f6f7fb; --card:#ffffff; --line:#e5e7eb; --chip:#eef2ff; --chipText:#3730a3;
      --accent:#4f46e5;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Ubuntu;background:var(--bg);color:var(--text)}
    header{padding:16px 20px;background:#fff;border-bottom:1px solid var(--line);position:sticky;top:0;z-index:10;display:flex;gap:12px;align-items:center}
    header a{color:var(--muted);text-decoration:none;margin-right:12px}
    .logo{width:22px;height:22px;border-radius:6px;background:linear-gradient(135deg,#7c3aed,var(--accent))}
    main{display:grid;grid-template-columns:1fr 420px;gap:16px;padding:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .card h2{margin:0;padding:12px 14px;border-bottom:1px solid var(--line);font-size:16px}
    .content{padding:12px 14px}
    .scroll{max-height:60vh;overflow:auto}

    .grid-head{display:grid;grid-template-columns:1fr 420px;gap:16px;padding:16px;padding-bottom:0}
    .viz{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:8px 10px}
    .legend{display:flex;gap:10px;align-items:center;margin:6px 0 2px 6px}
    .legend .dot{width:10px;height:10px;border-radius:999px}
    .dot.ok{background:var(--ok)} .dot.warn{background:var(--warn)} .dot.bad{background:var(--bad)}
    .legend span{font-size:12px;color:var(--muted)}
    .pie-wrap{display:flex;align-items:center;justify-content:center}

    table{width:100%;border-collapse:collapse}
    thead th{text-align:left;font-size:12px;color:var(--muted);font-weight:600;padding:8px 6px;border-bottom:1px solid var(--line)}
    tbody td{padding:10px 6px;border-bottom:1px solid #f1f5f9;font-size:14px}
    tbody tr{cursor:pointer} tbody tr:hover{background:#f8fafc}

    .pill{background:var(--chip);color:var(--chipText);padding:2px 8px;border:1px solid #e0e7ff;border-radius:999px;font-size:12px}
    .chip{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:600;background:#eef2f7}
    .chip.ok{color:var(--ok)} .chip.warn{color:var(--warn)} .chip.bad{color:var(--bad)}
    .bar{height:10px;background:#e5e7eb;border-radius:8px;overflow:hidden}
    .bar>span{display:block;height:100%;background:var(--accent)}
    .muted{color:var(--muted)} .small{font-size:12px}
    @media (max-width: 980px){ main{grid-template-columns:1fr}.grid-head{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <div class="logo"></div>
    <a href="/app">Home</a>
    <a href="/api/dashboard" style="font-weight:700;color:#111827">Dashboard</a>
    <a href="/docs">API docs</a>
  </header>

  <section class="grid-head">
    <div class="viz">
      <div class="legend">
        <div class="dot ok"></div><span>Healthy (≥ 70)</span>
        <div class="dot warn" style="margin-left:8px"></div><span>At-risk (30–70)</span>
        <div class="dot bad" style="margin-left:8px"></div><span>Churn-risk (&lt; 30)</span>
      </div>
      <div class="pie-wrap"><svg id="dist-pie" width="340" height="200" viewBox="0 0 340 200" role="img" aria-label="Customer distribution pie"></svg></div>
    </div>
    <div></div>
  </section>

  <main>
    <section class="card">
      <h2>Customers</h2>
      <div class="content scroll">
        <table>
          <thead>
            <tr><th>Name</th><th>Segment</th><th>Health</th><th>Status</th></tr>
          </thead>
          <tbody id="customers-body"></tbody>
        </table>
      </div>
    </section>

    <aside class="card" id="detail-card" hidden>
      <h2 id="detail-title">Health Detail</h2>
      <div class="content">
        <div class="row" style="display:flex;justify-content:space-between;align-items:center">
          <div class="muted">Customer</div><div class="pill" id="detail-segment">—</div>
        </div>
        <div class="row" style="display:flex;justify-content:space-between;margin-top:6px">
          <div class="muted">Health Score</div><div id="detail-score" class="chip">—</div>
        </div>

        <h3 class="small" style="margin-top:16px">Factors</h3>
        <div id="factors"></div>
      </div>
    </aside>
  </main>

<script>
const apiBase = location.origin;

function statusFromScore(s){
  if(s>=70) return {label:'Healthy',cls:'ok'};
  if(s>=30) return {label:'At-risk',cls:'warn'};
  return {label:'Churn-risk',cls:'bad'};
}
const percent = n => Math.max(0, Math.min(100, Math.round(n)));

function renderRow(c){
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>${c.name ?? '—'}</td>
    <td><span class="pill">${c.segment ?? '—'}</span></td>
    <td class="health" data-id="${c.id}">—</td>
    <td><span class="chip" id="status-${c.id}">—</span></td>
  `;
  tr.addEventListener('click', ()=>loadDetail(c));
  return tr;
}

async function fetchJSON(url, opts){
  const res = await fetch(url, opts);
  if(!res.ok) throw new Error(await res.text());
  return res.json();
}

async function loadCustomers(){
  const tbody = document.getElementById('customers-body');
  tbody.innerHTML = '<tr><td colspan="4" class="muted">Loading…</td></tr>';
  try{
    const list = await fetchJSON(`${apiBase}/api/customers`);
    tbody.innerHTML = '';
    list.forEach(c => tbody.appendChild(renderRow(c)));

    const dist = {healthy:0, risk:0, churn:0};
    await Promise.all(list.map(async c=>{
      try{
        const detail = await fetchJSON(`${apiBase}/api/customers/${c.id}/health`);
        const score = detail.healthScore ?? detail.health_score ?? 0;

        const cell = tbody.querySelector(`td.health[data-id="${c.id}"]`);
        if(cell) cell.textContent = percent(score);

        const chip = document.getElementById(`status-${c.id}`);
        if(chip){
          const {label, cls} = statusFromScore(score);
          chip.textContent = label;
          chip.className = `chip ${cls}`;
        }

        if(score>=70) dist.healthy++;
        else if(score>=30) dist.risk++;
        else dist.churn++;
      }catch{}
    }));

    drawPie(dist);
  }catch(e){
    tbody.innerHTML = `<tr><td colspan="4" class="muted">Failed to load: ${e.message}</td></tr>`;
  }
}

function factorBar(name, value){
  const v = percent(value);
  const wrap = document.createElement('div');
  wrap.style.marginTop='10px';
  wrap.innerHTML = `
    <div style="display:flex;justify-content:space-between">
      <div>${name}</div><div class="muted">${v}</div>
    </div>
    <div class="bar"><span style="width:${v}%"></span></div>
  `;
  return wrap;
}

async function loadDetail(cust){
  const card = document.getElementById('detail-card');
  card.hidden = false;
  document.getElementById('detail-title').textContent = `Health Detail — ${cust.name}`;
  document.getElementById('detail-segment').textContent = cust.segment ?? '—';

  const scoreChip = document.getElementById('detail-score');
  scoreChip.textContent = '…'; scoreChip.className = 'chip';

  const factors = document.getElementById('factors');
  factors.innerHTML = '<div class="muted small">Loading…</div>';
  try{
    const detail = await fetchJSON(`${apiBase}/api/customers/${cust.id}/health`);
    const score = detail.healthScore ?? detail.health_score ?? 0;
    scoreChip.textContent = percent(score);
    const {cls} = statusFromScore(score);
    scoreChip.className = `chip ${cls}`;

    factors.innerHTML = '';
    const keys = Object.keys(detail.factors || {});
    if(!keys.length) factors.innerHTML = '<div class="muted small">No factor breakdown returned.</div>';
    keys.forEach(k=>{
      const nice = k.replace(/([A-Z])/g,' $1').replace(/^./,s=>s.toUpperCase());
      factors.appendChild(factorBar(nice, detail.factors[k]));
    });
  }catch(e){
    factors.innerHTML = `<div class="muted small">Failed to load breakdown: ${e.message}</div>`;
  }
  // // Recent events are not part of the required endpoints
  // const eventsEl = document.getElementById('events');
  // eventsEl.textContent = 'Not available in this demo.';

  // // recent events (optional)
  // const eventsEl = document.getElementById('events');
  // eventsEl.textContent = '—';
  // try{
  //   const res = await fetch(`${apiBase}/api/customers/${cust.id}/events?limit=10`);
  //   if(res.ok){
  //     const items = await res.json();
  //     if(Array.isArray(items) && items.length){
  //       eventsEl.classList.remove('muted');
  //       eventsEl.innerHTML = items.map(ev=>{
  //         const t=ev.type||ev.event_type||'event';
  //         const ts=ev.timestamp||ev.created_at||ev.occurred_at||'';
  //         return `<div>• <strong>${t}</strong> <span class="muted small">${ts}</span></div>`;
  //       }).join('');
  //     }else eventsEl.textContent='No recent events.';
  //   }else eventsEl.textContent='Events endpoint not available.';
  // }catch{}
}

/* ---- Simple SVG pie renderer (no libs) ---- */
function drawPie(dist){
  const svg = document.getElementById('dist-pie');
  if(!svg) return;
  const total = dist.healthy + dist.risk + dist.churn || 1;
  const parts = [
    {label:'Healthy', value:dist.healthy, color:'var(--ok)'},
    {label:'At-risk', value:dist.risk, color:'var(--warn)'},
    {label:'Churn-risk', value:dist.churn, color:'var(--bad)'},
  ];

  svg.innerHTML = ''; // clear
  const cx=100, cy=100, r=80; // pie center & radius
  let angle = -Math.PI/2; // start at top

  parts.forEach(p=>{
    const frac = p.value/total;
    const end = angle + frac*2*Math.PI;
    const x1 = cx + r*Math.cos(angle), y1 = cy + r*Math.sin(angle);
    const x2 = cx + r*Math.cos(end),   y2 = cy + r*Math.sin(end);
    const largeArc = (end-angle) > Math.PI ? 1 : 0;

    const path = document.createElementNS('http://www.w3.org/2000/svg','path');
    const d = [
      `M ${cx} ${cy}`,
      `L ${x1} ${y1}`,
      `A ${r} ${r} 0 ${largeArc} 1 ${x2} ${y2}`,
      'Z'
    ].join(' ');
    path.setAttribute('d', d);
    path.setAttribute('fill', p.color);
    svg.appendChild(path);

    angle = end;
  });

  // add counts text
  const txt = document.createElementNS('http://www.w3.org/2000/svg','text');
  txt.setAttribute('x','220'); txt.setAttribute('y','90');
  txt.setAttribute('fill','#111827'); txt.setAttribute('font-size','12');
  txt.innerHTML = `Total: ${total}\nHealthy: ${dist.healthy}\nAt-risk: ${dist.risk}\nChurn: ${dist.churn}`.replace(/\n/g,'');
  // stack counts
  const lines = [
    `Total: ${total}`,
    `Healthy: ${dist.healthy}`,
    `At-risk: ${dist.risk}`,
    `Churn: ${dist.churn}`
  ];
  lines.forEach((line,i)=>{
    const tspan = document.createElementNS('http://www.w3.org/2000/svg','tspan');
    tspan.setAttribute('x','220');
    tspan.setAttribute('dy', i? '1.2em':'0');
    tspan.textContent = line;
    txt.appendChild(tspan);
  });
  svg.appendChild(txt);
}

loadCustomers();
</script>
</body>
</html>
