<!doctype html>
<html lang="en">
<head>
  <!-- Customer Health — Dashboard (aligned with Home: pastel cream bg + pastel hero banner) -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Customer Health — Dashboard</title>

  <style>
    /* =========================
       Shared Palette (matches home.html)
       ========================= */
    :root{
      /* Base */
      --bg:#f6f1e7;             /* pastel cream background */
      --text:#12312c;           /* deep ink */
      --muted:#5a6866;          /* muted ink */
      --card:#ffffff;
      --line:#e9e4da;

      /* Pastel accents (no harsh blue) */
      --brand:#0f3e36;          /* deep eucalyptus */
      --brand-soft:#dfeee9;     /* minty pastel */
      --accent1:#f6d6cf;        /* peach tint */
      --accent2:#e4d9f1;        /* lavender tint */
      --accent3:#d6ecf1;        /* powder cyan (very soft) */

      /* Status colors (unchanged semantics) */
      --ok:#2c7a66; --warn:#e7a437; --bad:#cb3b3b;

      --radius:16px;
      --shadow-sm:0 1px 2px rgba(0,0,0,.04);
      --shadow-md:0 10px 32px rgba(18,49,44,.10);
    }

    /* Base */
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial, ui-sans-serif, system-ui;
      background:var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      text-rendering:optimizeLegibility;
      line-height:1.5;
    }
    a{color:inherit;text-decoration:none}

    .container{max-width:1200px;margin:0 auto;padding:16px}

    /* =========================
       Header (brand left, nav right) — same pattern as Home
       ========================= */
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter:saturate(1.05) blur(6px);
      background:color-mix(in oklab, var(--bg) 88%, white);
      border-bottom:1px solid rgba(0,0,0,.06);
    }
    .nav{
      max-width:1200px; margin:0 auto;
      display:flex; align-items:center; justify-content:space-between; gap:16px;
      padding:12px 16px;
    }
    .brand{
      display:flex; align-items:center; gap:12px; font-weight:800; letter-spacing:-.01em;
    }
    .brand-mark{
      width:28px; height:28px; border-radius:8px; box-shadow:var(--shadow-sm);
      background:linear-gradient(135deg,#f6ebff,#fff1ea 60%, #e9f7f2);
      border:1px solid #ffffff7a; display:grid; place-items:center;
    }
    .brand-mark svg{width:16px;height:16px}
    .main-nav{display:flex; gap:32px}
    .main-nav a{
      color:var(--muted); font-weight:600; padding:6px 10px; border-radius:8px;
      transition:background .2s ease, color .2s ease;
    }
    .main-nav a:hover{color:var(--text); background:var(--brand-soft)}
    .main-nav a[aria-current="page"]{color:var(--text); background:color-mix(in oklab, var(--brand-soft) 75%, white)}

    /* =========================
       Hero (match Home top section)
       ========================= */
    .hero{
      position:relative;
      z-index: 1;
      background:
        radial-gradient(1200px 700px at 15% 15%, var(--accent2) 0%, transparent 55%),
        radial-gradient(1200px 700px at 85% 20%, var(--accent1) 0%, transparent 55%),
        radial-gradient(1200px 700px at 50% 95%, var(--accent3) 0%, transparent 55%),
        var(--bg);
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow:var(--shadow-sm);
      padding:18px 20px;
      margin-top:14px;
      overflow:hidden;
    }
    .hero-art{
      position:absolute; inset:0; pointer-events:none; opacity:.6; mix-blend:multiply; z-index: -4;
    }
    .hero-art img{
      position:absolute; inset:auto; left:0; right:0; top:-10px; bottom:0; margin:auto;
      width:min(1200px, 96%); filter:blur(.3px) saturate(104%);
    }

    .hero-head{display:flex;justify-content:space-between;align-items:center;gap:16px;flex-wrap:wrap}
    .hero-title{font-size:22px;font-weight:800;margin:0;letter-spacing:-.01em}
    .hero-sub{color:var(--muted);font-size:14px;margin-top:4px}

    /* KPI strip */
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:14px}
    .kpi{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px 14px;display:flex;flex-direction:column;gap:4px;align-items:flex-start}
    .kpi .label{font-size:12px;color:var(--muted)}
    .kpi .value{font-size:22px;font-weight:800;letter-spacing:-0.02em}
    .kpi.ok .value{color:var(--ok)} .kpi.warn .value{color:var(--warn)} .kpi.bad .value{color:var(--bad)}
    .kpi .delta{font-size:12px;color:var(--muted)}

    /* Cards / layout */
    .row{display:grid;grid-template-columns:1fr 420px;gap:16px;margin-top:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .card h2{margin:0;padding:12px 16px;border-bottom:1px solid var(--line);font-size:16px}
    .content{padding:14px 16px}
    .scroll{max-height:62vh;overflow:auto}

    /* Viz & helpers */
    .viz{padding:8px 10px}
    .legend{display:flex;gap:10px;align-items:center;justify-content:center;margin:6px 0 8px}
    .legend .dot{width:10px;height:10px;border-radius:999px}
    .dot.ok{background:var(--ok)} .dot.warn{background:var(--warn)} .dot.bad{background:var(--bad)}
    .legend span{font-size:12px;color:var(--muted)}

    .toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap}
    .search{flex:1;min-width:200px}
    .search input{width:100%;padding:9px 10px;border:1px solid var(--line);border-radius:10px;font-size:14px;background:#fff}
    .filters{display:flex;gap:8px}
    .select{padding:9px 10px;border:1px solid var(--line);border-radius:10px;font-size:14px;background:#fff}

    table{width:100%;border-collapse:collapse}
    thead th{text-align:left;font-size:12px;color:var(--muted);font-weight:700;padding:8px 6px;border-bottom:1px solid var(--line)}
    tbody td{padding:10px 6px;border-bottom:1px solid #f1f5f0;font-size:14px}
    tbody tr{cursor:pointer} tbody tr:hover{background:#f8faf2}

    .pill{background:#eef6f3;color:#0f5132;padding:2px 8px;border:1px solid #daede7;border-radius:999px;font-size:12px}
    .chip{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:700;background:#eef2f1}
    .chip.ok{color:var(--ok)} .chip.warn{color:var(--warn)} .chip.bad{color:var(--bad)}
    .bar{height:10px;background:#e5e7e1;border-radius:8px;overflow:hidden}
    .bar>span{display:block;height:100%;background:var(--brand);transform-origin:left center;transition:transform .4s ease}

    @media (max-width: 1100px){
      .row{grid-template-columns:1fr}
      .scroll{max-height:none}
      .main-nav{gap:20px}
    }
  </style>
</head>
<body>
  <!-- Header: matches home (logo left, nav right; one link per route) -->
  <header>
    <nav class="nav" aria-label="Primary">
      <a class="brand" href="/home.html" aria-label="Customer Health — Home">
        <span class="brand-mark" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M4 14.5l4-4 3 3 5-5 4 4" stroke="#0f3e36" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <circle cx="6" cy="18" r="2" fill="#2c7a66"/>
          </svg>
        </span>
        <span>Customer Health</span>
      </a>

      <div class="main-nav" role="navigation">
        <a href="/home.html">Home</a>
        <a href="/dashboard.html" aria-current="page">Dashboard</a>
        <a href="/docs">API Docs</a>
      </div>
    </nav>
  </header>

  <div class="container">
    <!-- HERO / KPIs: same pastel banner feel as Home -->
    <section class="hero">
      <div class="hero-art" aria-hidden="true">
        <!-- Use the same hero art image as home (placed in /assets) -->
        <img src="/assets/home-hero.jpg" alt="" loading="lazy">
      </div>

      <div class="hero-head">
        <div>
          <h1 class="hero-title">Customer Health Dashboard</h1>
          <div class="hero-sub">Overview of engagement, adoption, support load, billing reliability, and API momentum</div>
        </div>
        <div class="legend" aria-label="Score legend">
          <div class="dot ok"></div><span>Healthy (≥ 70)</span>
          <div class="dot warn" style="margin-left:8px"></div><span>At-risk (50–69)</span>
          <div class="dot bad" style="margin-left:8px"></div><span>Churn-risk (&lt; 50)</span>
        </div>
      </div>

      <div class="kpis" role="list">
        <div class="kpi" role="listitem">
          <div class="label">Total Customers</div>
          <div class="value" id="kpi-total">—</div>
          <div class="delta muted" id="kpi-last-update">loading…</div>
        </div>
        <div class="kpi ok" role="listitem">
          <div class="label">Healthy</div>
          <div class="value" id="kpi-healthy">—</div>
          <div class="delta muted" id="kpi-healthy-pct">—</div>
        </div>
        <div class="kpi warn" role="listitem">
          <div class="label">At-risk</div>
          <div class="value" id="kpi-risk">—</div>
          <div class="delta muted" id="kpi-risk-pct">—</div>
        </div>
        <div class="kpi bad" role="listitem">
          <div class="label">Churn-risk</div>
          <div class="value" id="kpi-churn">—</div>
          <div class="delta muted" id="kpi-churn-pct">—</div>
        </div>
      </div>
    </section>

    <!-- DISTRIBUTION -->
    <section class="card viz" style="margin-top:14px">
      <div class="pie-wrap" style="display:flex;align-items:center;justify-content:center">
        <svg id="dist-pie" width="660" height="220" viewBox="0 0 660 220" role="img" aria-label="Customer health distribution"></svg>
      </div>
    </section>

    <!-- GRID -->
    <section class="row">
      <section class="card">
        <h2>Customers</h2>
        <div class="content">
          <div class="toolbar">
            <div class="search"><input id="search" type="search" placeholder="Search by name…" /></div>
            <div class="filters">
              <select id="segment" class="select">
                <option value="">All segments</option>
                <option value="enterprise">Enterprise</option>
                <option value="SMB">SMB</option>
                <option value="startup">Startup</option>
              </select>
              <select id="status" class="select">
                <option value="">All statuses</option>
                <option value="healthy">Healthy (≥70)</option>
                <option value="risk">At-risk (50–69)</option>
                <option value="churn">Churn-risk (&lt;50)</option>
              </select>
            </div>
          </div>

          <div class="scroll">
            <table>
              <thead>
                <tr><th style="width:40%">Name</th><th style="width:20%">Segment</th><th style="width:20%">Health</th><th style="width:20%">Status</th></tr>
              </thead>
              <tbody id="customers-body"></tbody>
            </table>
          </div>
        </div>
      </section>

      <aside class="card" id="detail-card" hidden>
        <h2 id="detail-title">Health Detail</h2>
        <div class="content">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="muted">Customer</div><div class="pill" id="detail-segment">—</div>
          </div>
          <div style="display:flex;justify-content:space-between;margin-top:6px">
            <div class="muted">Health Score</div><div id="detail-score" class="chip">—</div>
          </div>

          <h3 class="small" style="margin-top:16px">Factors</h3>
          <div id="factors"></div>
        </div>
      </aside>
    </section>
  </div>

<script>
const apiBase = location.origin;

const percent = n => Math.max(0, Math.min(100, Math.round(n)));
function statusFromScore(s){
  if(s>=70) return {label:'Healthy',cls:'ok',key:'healthy'};
  if(s>=50) return {label:'At-risk',cls:'warn',key:'risk'};
  return {label:'Churn-risk',cls:'bad',key:'churn'};
}

function renderRow(c){
  const tr = document.createElement('tr');
  tr.dataset.name = (c.name||'').toLowerCase();
  tr.dataset.segment = c.segment||'';
  tr.dataset.id = c.id;

  tr.innerHTML = `
    <td>${c.name ?? '—'}</td>
    <td><span class="pill">${c.segment ?? '—'}</span></td>
    <td class="health">—</td>
    <td><span class="chip">—</span></td>
  `;
  tr.addEventListener('click', ()=>loadDetail(c));
  return tr;
}

async function fetchJSON(url, opts){
  const res = await fetch(url, opts);
  if(!res.ok) throw new Error(await res.text());
  return res.json();
}

async function loadCustomers(){
  const tbody = document.getElementById('customers-body');
  tbody.innerHTML = '<tr><td colspan="4" class="muted">Loading…</td></tr>';
  let list = [];
  const dist = {healthy:0, risk:0, churn:0};

  try{
    list = await fetchJSON(`${apiBase}/api/customers`);
    tbody.innerHTML = '';
    list.forEach(c => tbody.appendChild(renderRow(c)));

    await Promise.all(list.map(async c=>{
      try{
        const detail = await fetchJSON(`${apiBase}/api/customers/${c.id}/health`);
        const score = detail.healthScore ?? detail.health_score ?? 0;

        const row = tbody.querySelector(`tr[data-id="${c.id}"]`);
        row.dataset.score = score;

        const healthCell = row.querySelector('td.health');
        if(healthCell) healthCell.textContent = percent(score);

        const chip = row.querySelector('.chip');
        if(chip){
          const {label, cls, key} = statusFromScore(score);
          chip.textContent = label;
          chip.className = `chip ${cls}`;
          row.dataset.status = key;
        }

        if(score>=70) dist.healthy++;
        else if(score>=50) dist.risk++;
        else dist.churn++;
      }catch{}
    }));

    updateKPIs(dist, list.length);
    drawPie(dist);
    attachFiltering();
  }catch(e){
    tbody.innerHTML = `<tr><td colspan="4" class="muted">Failed to load: ${e.message}</td></tr>`;
  }
}

function factorBar(name, value){
  const v = percent(value);
  const wrap = document.createElement('div');
  wrap.style.marginTop='10px';
  wrap.innerHTML = `
    <div style="display:flex;justify-content:space-between">
      <div>${name}</div><div class="muted">${v}</div>
    </div>
    <div class="bar"><span style="transform:scaleX(${v/100})"></span></div>
  `;
  return wrap;
}

async function loadDetail(cust){
  const card = document.getElementById('detail-card');
  card.hidden = false;
  document.getElementById('detail-title').textContent = `Health Detail — ${cust.name}`;
  document.getElementById('detail-segment').textContent = cust.segment ?? '—';

  const scoreChip = document.getElementById('detail-score');
  scoreChip.textContent = '…'; scoreChip.className = 'chip';

  const factors = document.getElementById('factors');
  factors.innerHTML = '<div class="muted small">Loading…</div>';
  try{
    const detail = await fetchJSON(`${apiBase}/api/customers/${cust.id}/health`);
    const score = detail.healthScore ?? detail.health_score ?? 0;
    scoreChip.textContent = percent(score);
    const {cls} = statusFromScore(score);
    scoreChip.className = `chip ${cls}`;

    factors.innerHTML = '';
    const keys = Object.keys(detail.factors || {});
    if(!keys.length) factors.innerHTML = '<div class="muted small">No factor breakdown returned.</div>';
    keys.forEach(k=>{
      const nice = k.replace(/([A-Z])/g,' $1').replace(/^./,s=>s.toUpperCase());
      factors.appendChild(factorBar(nice, detail.factors[k]));
    });
  }catch(e){
    factors.innerHTML = `<div class="muted small">Failed to load breakdown: ${e.message}</div>`;
  }
}

/* ---- KPIs ---- */
function updateKPIs(dist, total){
  const $ = id => document.getElementById(id);
  const pct = (n)=> total? `${Math.round(n/total*100)}%` : '—';

  $('kpi-total').textContent = total || '0';
  $('kpi-healthy').textContent = dist.healthy;
  $('kpi-risk').textContent = dist.risk;
  $('kpi-churn').textContent = dist.churn;

  $('kpi-healthy-pct').textContent = pct(dist.healthy);
  $('kpi-risk-pct').textContent = pct(dist.risk);
  $('kpi-churn-pct').textContent = pct(dist.churn);

  const now = new Date();
  $('kpi-last-update').textContent = `Updated ${now.toLocaleString()}`;
}

/* ---- Pie (SVG, centered) ---- */
function drawPie(dist){
  const svg = document.getElementById('dist-pie');
  if(!svg) return;
  svg.innerHTML = '';

  const W = 660, H = 220;
  const r = 90;
  const cx0 = 140;      // pie center (original)
  const labelX0 = 310;  // labels start (original)

  // Center composition
  const compMid = (cx0 + labelX0) / 2;
  const shiftX = (W / 2) - compMid;

  const g = document.createElementNS('http://www.w3.org/2000/svg','g');
  g.setAttribute('transform', `translate(${shiftX},0)`);
  svg.appendChild(g);

  const total = dist.healthy + dist.risk + dist.churn || 1;
  const parts = [
    {label:'Healthy', value:dist.healthy, color:'var(--ok)'},
    {label:'At-risk', value:dist.risk, color:'var(--warn)'},
    {label:'Churn-risk', value:dist.churn, color:'var(--bad)'},
  ];

  let angle = -Math.PI/2;
  const cx = cx0, cy = H/2;

  parts.forEach(p=>{
    const frac = p.value/total;
    const end = angle + frac*2*Math.PI;
    const x1 = cx + r*Math.cos(angle), y1 = cy + r*Math.sin(angle);
    const x2 = cx + r*Math.cos(end),   y2 = cy + r*Math.sin(end);
    const largeArc = (end-angle) > Math.PI ? 1 : 0;

    const path = document.createElementNS('http://www.w3.org/2000/svg','path');
    path.setAttribute('d', `M ${cx} ${cy} L ${x1} ${y1} A ${r} ${r} 0 ${largeArc} 1 ${x2} ${y2} Z`);
    path.setAttribute('fill', p.color);
    g.appendChild(path);

    angle = end;
  });

  // Labels
  const labelX = labelX0, baseY = cy - 20;
  const lines = [
    `Total: ${total}`,
    `Healthy: ${dist.healthy}`,
    `At-risk: ${dist.risk}`,
    `Churn: ${dist.churn}`
  ];
  const text = document.createElementNS('http://www.w3.org/2000/svg','text');
  text.setAttribute('x', labelX);
  text.setAttribute('y', baseY);
  text.setAttribute('fill','#111827');
  text.setAttribute('font-size','14');
  lines.forEach((line,i)=>{
    const tspan = document.createElementNS('http://www.w3.org/2000/svg','tspan');
    tspan.setAttribute('x', labelX);
    tspan.setAttribute('dy', i? '1.4em':'0');
    tspan.textContent = line;
    text.appendChild(tspan);
  });
  g.appendChild(text);
}

/* ---- Filtering (search, segment, status) ---- */
function attachFiltering(){
  const search = document.getElementById('search');
  const segSel = document.getElementById('segment');
  const statSel = document.getElementById('status');
  const tbody = document.getElementById('customers-body');

  function apply(){
    const q = (search.value||'').toLowerCase();
    const seg = segSel.value;
    const st = statSel.value;

    Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{
      const okName = !q || tr.dataset.name.includes(q);
      const okSeg  = !seg || tr.dataset.segment === seg;
      const okSt   = !st  || tr.dataset.status === st;
      tr.style.display = (okName && okSeg && okSt) ? '' : 'none';
    });
  }
  search.addEventListener('input', apply);
  segSel.addEventListener('change', apply);
  statSel.addEventListener('change', apply);
}

loadCustomers();
</script>
</body>
</html>
